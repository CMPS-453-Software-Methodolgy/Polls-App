name: build
description: 'Setup Django environment'

inputs:
    python-version:
        description: 'Python version'
        default: '3.11'
        required: false
    os:
        description: 'Operating system'
        default: 'ubuntu-latest'
        required: false

runs:
    using: composite
    steps:
        - name: Set up Python ${{ inputs.python-version }} on ${{ inputs.os }}
          id: setup-python
          uses: actions/setup-python@v5
          with:
              python-version: ${{ inputs.python-version }}

        - name: Get pip cache directory
          shell: bash
          id: pip-cache-dir
          run: |
              echo "::set-output name=dir::$(pip cache dir)"

        - name: Cache virtual environment
          uses: actions/cache@v4
          id: cache
          with:
              path: |
                  venv
                  ${{ steps.pip-cache-dir.outputs.dir }}
              key: ${{ runner.os }}-venv-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('requirements.txt') }}
              restore-keys: |
                  ${{ runner.os }}-venv-

        - name: Create virtual environment (Git bash)
          shell: bash
          if: ${{ (steps.cache.outputs.cache-hit != 'true') && (runner.os == 'Windows') }}$
          run: |
              pip install -q virtualenv
              python -m venv venv
              source venv/Scripts/activate
              python -m pip install --upgrade -q pip
              pip install --no-cache-dir -qr requirements.txt

        - name: Create virtual environment (Git bash)
          shell: bash
          if: ${{ (steps.cache.outputs.cache-hit != 'true') && (runner.os != 'Windows') }}$
          run: |
              pip install -q virtualenv
              python -m venv venv
              source venv/bin/activate
              python -m pip install --upgrade -q pip
              pip install --no-cache-dir -qr requirements.txt

        - name: Activate virtual environment (Git Bash)
          shell: bash
          if: runner.os == 'Windows'
          run: |
              source venv/Scripts/activate

        - name: Activate virtual environment (Linux/macOS)
          shell: bash
          if: runner.os != 'Windows'
          run: |
              source venv/bin/activate

        - name: Django Migrate
          shell: bash
          run: |
              python manage.py migrate >/dev/null

        - name: Django Collectstatic
          shell: bash
          run: |
              python manage.py collectstatic --no-input >/dev/null
